{% extends 'base.html' %}
{% block content %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <div style="padding: 50px;font-family: 'Gmarket'">
        <h1>글자수세기</h1>
        <div class="form-floating" style="border: 2px solid darkslategray; border-top-left-radius: 10px; border-top-right-radius: 10px; padding: 20px; padding-left: 30px">
            <div style="display:flex; flex-wrap: wrap">
                <div style="min-width: 400px;width: 50%">
                    <h6 style="font-family: 'Gmarket'">입력창</h6>
                    <textarea class="form-control no-outline" id="textInput" style="font-size: 17px; min-height:300px; border: none; outline:none; font-family:'KoPub Dotum'; resize: both" spellcheck="false"></textarea>
                </div>
                <div style="min-width: 400px; width: 50%">
                    <h6 style="font-family: 'Gmarket'; margin:0px">맞춤법 검사 결과</h6>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button class='btn btn-success' id="checkButton">맞춤법 검사</button>
                <label for="fontSize" style="margin-left: 10px;">글자 크기:</label>
                <input type="number" id="fontSize" value="17" style="width: 60px;">
            </div>
            <div class="loading" id="loading" style="color:gray">로딩 중...</div>
        </div>

        <div style="border: 2px solid darkslategray; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; padding: 20px; padding-left: 30px; border-top:none">
            <h6 style="font-family: 'Gmarket'">글자 정보</h6>
            <table class="table table-bordered " style="max-width: 700px">
                <thead>
                    <tr class="text-center">
                        <th>byte</th>
                        <th>글자 수(공백포함)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="text-center" style="font-size:25px">
                        <td class="border">
                            <span id="byteCount">0</span>
                        </td>
                        <td>
                            <span id="charCount">0</span>
                        </td>
                    </tr>
                </tbody>
            </table>

        </div>

        <br>
        <h7 style="color:blue; font-family: 'Gmarket'">※DG1S LMS는 사용자의 정보를 절대로 <u>저장 및 재가공하지 않습니다</u>.</h7>
        <br>
        <h7 style="color:gray; font-family: 'Gmarket'">※본 프로그램 사용으로인한 불이익에 대한 책임은 사용자에게 있습니다.</h7>
        <br>
        <h7 style="color:gray; font-family: 'Gmarket'">※바이트 기준은 다음과 같습니다.</h7>
        <table class="table table-bordered " style="max-width: 700px">
                <thead>
                    <tr class="text-center">
                        <th>한글</th>
                        <th>엔터</th>
                        <th>영어, 기호</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="text-center">
                        <td>
                            3byte
                        </td>
                        <td>
                            2byte
                        </td>
                        <td>
                            1byte
                        </td>
                    </tr>
                </tbody>
            </table>
        <br>
        <h7 style="color:gray; font-family: 'Gmarket'">POWERED by NAVER</h7>
    </div>

    <script>
        $(document).ready(function() {
            // 입력 창에서 글자 크기 조절
            $('#fontSize').on('input', function() {
                const fontSize = $(this).val();
                $('#textInput').css('font-size', fontSize + 'px');
                $('#correctedText').css('font-size', fontSize + 'px');
            });

            // 글자 수와 바이트 수 업데이트
            $('#textInput').on('input', function() {
                const text = $(this).val();
                updateCounts(text);
            });

            // 맞춤법 검사 버튼 클릭 이벤트
            $('#checkButton').on('click', function() {
                const text = $('#textInput').val();
                $('#loading').show();
                checkSpelling(text);
            });

            // 글자 수와 바이트 수 계산 함수
            function updateCounts(text) {
                const charCount = text.length;
                const byteCount = getByteCount(text);
                $('#charCount').text(charCount);
                $('#byteCount').text(byteCount);
            }

            // 바이트 수 계산 함수
            function getByteCount(text) {
                let byteCount = 0;
                for (let i = 0; i < text.length; i++) {
                    const char = text.charAt(i);
                    if (char.match(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/)) {
                        byteCount += 3;
                    } else if (char === '\n') {
                        byteCount += 2;
                    } else {
                        byteCount += 1;
                    }
                }
                return byteCount;
            }

            // 맞춤법 검사 함수
            // 맞춤법 검사 함수
            function checkSpelling(text) {
                $('#loading').show();  // 로딩 애니메이션 표시
                $.ajax({
                    url: 'https://api.openai.com/v1/engines/davinci/completions',
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer YOUR_OPENAI_API_KEY',
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        prompt: "문법이 올바른지 확인하고, 잘못된 부분을 수정하세요: " + text,
                        max_tokens: 150
                    }),
                    success: function(response) {
                        $('#loading').hide();
                        const correctedText = response.choices[0].text.trim();
                        $('#correctedText').text(correctedText);
                    },
                    error: function(xhr, status, error) {
                        $('#loading').hide();
                        console.error('Error:', status, error);
                        $('#spellCheckResult').text('맞춤법 검사 실패');
                    }
                });
            }


            // 페이지 새로고침 또는 나가기 시 확인 메시지
            window.addEventListener('beforeunload', function (e) {
                e.preventDefault();
                e.returnValue = '';
            });
        });
    </script>
{% endblock %}
